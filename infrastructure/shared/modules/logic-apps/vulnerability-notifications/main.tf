# Logic App needs
#   - (automated) System assigned identity w. Keyvault access to fetch clientId/clientSecret for API
#   - (manual) Principal to create clientId/clientSecret to access Azure Subassesment API


locals {
  env = var.app_env == "shared-stage"? "stage_" : ""
  logic_app_content_arm_template    = file("${path.module}/arms/${local.env}logic_app_content.json")
  kv_connection_arm_template        = file("${path.module}/arms/${local.env}kv_connection.json")
  office365_connection_arm_template = file("${path.module}/arms/${local.env}office365_connection.json")
  repos_file_path_template          = file("${path.module}/repos.json")
}

resource "azurerm_logic_app_workflow" "logicapp" {
  location            = var.resource_group_location
  resource_group_name = var.resource_group_name
  name                = var.logic_app_name

  identity {
    type = "SystemAssigned"
  }

  lifecycle {
    ignore_changes = [
      # Ignore changes to parameters as otherwise we will break the $connections
      parameters,
      workflow_parameters,
      tags
    ]
  }
}


resource "azurerm_resource_group_template_deployment" "kv_conn_deployment" {
  name                = var.keyvault_conn_deployment_name
  resource_group_name = var.resource_group_name
  deployment_mode     = "Incremental"

  parameters_content = jsonencode({
    connections_keyvault_2_name = { value = var.keyvault_api_name }
  })

  template_content = local.kv_connection_arm_template
}

resource "azurerm_resource_group_template_deployment" "office_conn_deployment" {
  name                = var.office_conn_deployment_name
  resource_group_name = var.resource_group_name
  deployment_mode     = "Incremental"

  parameters_content = jsonencode({
    connections_office365_name = { value = var.office_api_name }
  })

  template_content = local.office365_connection_arm_template
}

# NOTE: The connection is no connection string, its the connection id of which provider to use
# Example: /subscriptions/someSubscript/resourceGroups/someResurceGroup/providers/Microsoft.Web/connections/keyvault-2

resource "azurerm_resource_group_template_deployment" "la_deployment" {
  name                = var.logic_app_deployment_name
  resource_group_name = var.resource_group_name
  deployment_mode     = "Incremental"
  parameters_content = jsonencode({
    logic_app_name        = { value = var.logic_app_name }
    keyvault_connection   = { value = var.keyvault_connection },
    office_365_connection = { value = var.office_365_connection },
    selected_repositories = { value = local.repos_file_path_template },
  })

  template_content = local.logic_app_content_arm_template

}

resource "azurerm_key_vault_access_policy" "la_policy" {
  key_vault_id = var.key_vault_id
  tenant_id    = var.tenant_id
  object_id    = azurerm_logic_app_workflow.logicapp.identity[0].principal_id
  secret_permissions = [
    "Get"
  ]
}
